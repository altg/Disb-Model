---
title: "Disbursement Projection Model"
author: "Altaf Abdul Gaffar (FPPA)"
subtitle: Testing and Performance Evaluation
output:
  pdf_document: default
  html_document:
    df_print: paged
editor_options:
  chunk_output_type: console
---

# Introduction

Moody's Analytics developed a Disbursement Projection Model (DM) to project future disbursement for IsDB Projects as part of the ERM Project. The tests done on this DM and the results are captured in this document.

# Testing Methodology

The testing methodology was designed to achieve the following aims:

1.  Check if model can execute / operate as expected without any errors

2.  The ability of the model to handle different types of inputs as per specification

3.  Measure the performance of the model using standard metrics

To achieve the above aims the following tests were developed:

1.  Run the model using simulated data, with objective to see how the model performs in the presence of new / unseen data

2.  Run the model using a sampled subset of the training data and compare the predicted values with the actual values

# Generation of Test inputs

> **Project Types**

Types of Projects used in our test sample

> Not Signed

These are projects that have been approved but not yet signed.

> Not Effective

These are projects which have been approved and signed, but not yet declared as effective

> Not Disbursing

These are projects which have been approved, signed, and declared as effective, but yet to begin disbursing.

> Disbursing

These are projects which have been approved, signed, declared as effective, and have started disbursing.

> **Testing Plan**

For each of the project types above we calculate the times (X) as shown in the table below.

+----------------+--------------+-----------------+-------------------+------------------------+
| Project Type   | Time to Sig. | Time of Effect. | Time to 1st Disb. | Time 1st to Last Disb. |
+================+==============+=================+===================+========================+
| Not Signed     | X            | X               | X                 | X                      |
+----------------+--------------+-----------------+-------------------+------------------------+
| Not Effective  | \-           | X               | X                 | X                      |
+----------------+--------------+-----------------+-------------------+------------------------+
| Not Disbursing | \-           | \-              | X                 | X                      |
+----------------+--------------+-----------------+-------------------+------------------------+
| Disbursing     | \-           | \-              | \-                | X                      |
+----------------+--------------+-----------------+-------------------+------------------------+

# Analysis 1 - Simulated Data

The simulated data was generated as follows:


1. Sample Train DS - Random sampling from Training Data
2. Create Project Types - The project types stated above are generated
3. Randomize Fields - Key fields i.e. Sector, Profile are randomized, and also the milestone dates
4. Merge with External DS - For external indicators
5. Write to File - Save to CSV file in format accepted by the model




```{r eval=FALSE, include=FALSE}

library(DiagrammeR)

grViz("digraph test{
  graph [layout = dot, rankdir = LR]
  
  node [shape = rectangle]        
  rec1 [label = 'Step 1. Sample Train DS']
  rec2 [label = 'Step 2. Create Project Types']
  rec3 [label =  'Step 3. Randomize Fields']
  rec4 [label = 'Step 4. Merge with External DS']
  rec5 [label = 'Step 5. Write to File']
  
  
  # edge definitions with the node IDs
  rec1 -> rec2 -> rec3 -> rec4 -> rec5
  }")

```



```{r setup, include=FALSE}
library(tidyverse)
library(lubridate)
library(readxl)
library(DataExplorer)
library(patchwork)

library(gt)

theme_set(theme_minimal())

dir <- getwd()   #Updates the path to the directory where the R Code is present
input_dir <- paste0(dir, "/Inputs/") 

output_dir <- paste0(dir , "/Outputs/")

ops_data_in <- read_excel("Tests/idb_data.xlsx", 
    sheet = "ops_data")

```


```{r datainput sim, include=FALSE}

model_input_sim <- read_csv(file = paste0(input_dir, "isdb_test_prjs_sim.csv")) %>% 
  select( -...1) %>% 
  mutate( proj_type = str_replace(project_title,  '-.*' , ''))

model_output_sim <- readRDS( file = paste0(output_dir , "model_output_sim.rda")) %>% 
  janitor::clean_names() %>% 
  mutate(
    proj_type = str_replace(project_title,  '-.*' , '')
  )

model_output_sim <- model_output_sim %>% 
  inner_join( model_input_sim %>%  select(where( is.character ) , -proj_type , -project_title, -project_title_org  ) , by = c("project_id"))


profiles_sim <- readRDS(file = paste0(output_dir , "full_disb_profile_sim.rda")) %>% 
  janitor::clean_names()

```

## Output Data Summary
```{r include=FALSE}
introduce(model_output_sim) %>% 
  pivot_longer(1:9) %>% 
  gt()


model_output_sim %>%  
  count(proj_type) %>% 
  gt() %>% 
  tab_header(
    title = "Model Output by Project Type"
  )

```



## Distribution - Input data

```{r echo=FALSE}
plot_dcvar <- function(var) {
  
  model_input_sim %>% 
  group_by( proj_type ) %>% 
  count( !!sym(var) , sort = T) %>% 
  mutate( dc_var = tidytext::reorder_within( !!sym(var) ,  n , proj_type)) %>% 
  ggplot(aes( dc_var , n)) +
  geom_col(aes(fill=proj_type), show.legend = FALSE) +
  coord_flip() +
  tidytext::scale_x_reordered() +
  facet_wrap(~proj_type, scales = "free_y") 
  
}

l <- c( "sector" , "sub_mode_of_finance" ,  "income_classification")

map(l , plot_dcvar)



```

## Check Model Output

```{r echo=FALSE}

apr_amt <- model_input_sim %>%  
   summarise( total_apr_amt = sum(approval_amount_usd)/1e6 ) 

disb_amt <- profiles_sim %>%  summarise( total_disb = sum( amount_disbursed_between_tenors ) /1e6 )

tibble( 
  apr_amt,
  disb_amt 
  ) %>% 
  mutate(
    match = (  apr_amt == disb_amt )
  ) %>% 
  gt() %>% 
  fmt_number(columns = 1:2) %>% 
  tab_footnote(
    footnote = "Total value of approved amounts from Test data set (input)",
    locations = cells_column_labels(
      columns = 1
    )
  ) %>% 
  tab_footnote(
    footnote = "Total value of disbursed amounts from disbursement profiles generated from the model",
    locations = cells_column_labels(
      columns = 2
    )
  ) %>% 
  tab_header(
    title = "Model Input / Output Reconciliation"
  )
```



## Distribution of Times - Output Data


```{r eval=FALSE, include=FALSE}
t <- model_output_sim %>% 
  select(proj_type , days_from_approval_to_signature , days_from_signature_to_effectiveness,
         days_from_effectiveness_to_first_disbursement , days_from_first_to_final_disbursement)

plot_boxplot(t, by = "proj_type" , ncol = 2)

```


```{r get_each, echo=FALSE}
get_each <- function(x ,data){
  data %>% 
    summarise(
    across( (starts_with("days_from") & contains(x) & !contains("_cap")) , 
            list(mean = mean , sd = sd , min = min , max = max , median = median),  
            .names = "{.fn}" ) ,
  ) %>% 
    mutate(measure = x) %>% 
    relocate(measure)
  
}

l2 <- c("approval_to_signature" , "signature_to_effectiveness" , "effectiveness_to_first" ,"first_to_final" )


```

```{r plot_hist, include=FALSE}
plot_hist <- function(data_src , var){
  
  mean_val = mean(var)
  
  #medean_val = median(var)
  
  var_name = str_remove( deparse(substitute(var)) , ".*\\$days_from_" )
  
  #geom_histogram(aes(y=..density.. , fill = ), fill="lightblue")+

  
  data_src %>% 
  ggplot(aes(var)) +
  #geom_histogram(aes(y=..density.. , fill = catch_up_shift ) )+
  geom_histogram(aes(y=..density.. ) , bins = 30 , alpha = .5)+
  #geom_density(alpha=.2, fill="#FF6666") +
  geom_density(alpha=.2) + 
  geom_vline(aes(xintercept= mean_val),
            color="black", linetype="dashed", size=.5 , alpha = .5) +
  # geom_vline(aes(xintercept= medean_val),
  #           color="blue", linetype="dashed", size=.5 , alpha = .5) +
  annotate("text" , x = mean_val , y  = 0 , label = paste0(sprintf("Avg. %.2f",mean_val)) , color = "red") +
  labs(title = var_name)
  
}
```



## Not Signed Projects
```{r echo=FALSE}

data_in <- model_output_sim %>% 
  filter(proj_type == "Not Signed" )

map_dfr(l2, get_each , data_in ) %>% 
  gt() %>% 
    fmt_number(columns = 2:6) %>% 
  tab_header(
    title = "Projection - Not Signed Projects",
    subtitle = "Model Output Milestone Time Analysis"
  )




p1 <- plot_hist(data_in , data_in$days_from_approval_to_signature)
  
  
p2 <- plot_hist(data_in , data_in$days_from_signature_to_effectiveness)


p3 <- plot_hist(data_in , data_in$days_from_effectiveness_to_first_disbursement)
  
  
p4 <- plot_hist(data_in , data_in$days_from_first_to_final_disbursement)
  
 

(p1 | p2) / (p3 | p4) + plot_annotation(
  title = 'Model Output - Projects Not Signed',
  subtitle = 'Distribution of projected time-taken by milestones(months)',
  caption = paste0('Based on a sample input of ' , nrow(data_in) , ' Approved but not Signed projects')
)


#t <- map(l4 , plot_dist2 , model_output_sim %>% filter(proj_type == "Not Signed" ) )

#map( 1:4 , ~wrap_plots(t[[.x]]) )

```


## Not Effective Projects
```{r echo=FALSE}

data_in <- model_output_sim %>% 
  filter(proj_type == "Not Effective" )

map_dfr(l2[2:4], get_each , data_in) %>% 
  gt() %>% 
    fmt_number(columns = 2:6) %>% 
  tab_header(
    title = "Projection - Not Effective Projects",
    subtitle = "Model Output Milestone Time Analysis"
  )

p1 <- plot_hist(data_in , data_in$days_from_signature_to_effectiveness)


p2 <- plot_hist(data_in , data_in$days_from_effectiveness_to_first_disbursement)
  
  
p3 <- plot_hist(data_in , data_in$days_from_first_to_final_disbursement)
  
 

(p1 | p2) / (p3 ) + plot_annotation(
  title = 'Model Output - Projects Not Signed',
  subtitle = 'Distribution of projected time-taken by milestones(months)',
  caption = paste0('Based on a sample input of ' , nrow(data_in) , ' Approved but not Signed projects')
)


#t <- map(l4 , plot_dist2 , model_output_sim %>% filter(proj_type == "Not Signed" ) )

#map( 1:4 , ~wrap_plots(t[[.x]]) )

# t <- map(l4[2:4] , plot_dist2 , model_output_sim %>% filter(proj_type == "Not Effective") )
# 
# 
# map( 1:3 , ~wrap_plots(t[[.x]] , ncol = 2) )

```


## Not Disbursing Projects

```{r echo=FALSE}
data_in <- model_output_sim %>% 
  filter(proj_type == "Not Disbursing" )

map_dfr(l2[3:4], get_each , data_in) %>% 
  gt() %>% 
    fmt_number(columns = 2:6) %>% 
  tab_header(
    title = "Projection - Not Disbursing Projects",
    subtitle = "Model Output Milestone Time Analysis"
  )

p1 <- plot_hist(data_in , data_in$days_from_effectiveness_to_first_disbursement)
  
  
p2 <- plot_hist(data_in , data_in$days_from_first_to_final_disbursement)
  
 

(p1 | p2)  + plot_annotation(
  title = 'Model Output - Projects Not Disbursing',
  subtitle = 'Distribution of projected time-taken by milestones(months)',
  caption = paste0('Based on a sample input of ' , nrow(data_in) , ' Approved but not Signed projects')
)

# t <- map(l4[3:4] , plot_dist2 , model_output_sim %>% filter(proj_type == "Not Disbursing") )
# 
# 
# map( 1:2 , ~wrap_plots(t[[.x]] , ncol = 2) )


```


## Disbursing Projects

```{r echo=FALSE}
data_in <- model_output_sim %>% 
  filter(proj_type == "Disbursing" )

map_dfr(l2[4], get_each , data_in) %>% 
  gt() %>% 
    fmt_number(columns = 2:6) %>% 
  tab_header(
    title = "Projection - Disbursing Projects",
    subtitle = "Model Output Milestone Time Analysis"
  )

p1 <- plot_hist(data_in , data_in$days_from_first_to_final_disbursement)
  
 

p1  + plot_annotation(
  title = 'Model Output - Disbursing Projects',
  subtitle = 'Distribution of projected time-taken by milestones(months)',
  caption = paste0('Based on a sample input of ' , nrow(data_in) , ' Approved but not Signed projects')
)

# t <- map(l4[4] , plot_dist2 , model_output_sim %>% filter(proj_type == "Disbursing") )
# 
# 
# map( 1 , ~wrap_plots(t[[.x]] , ncol = 2) )


```


## Distribution of Times - Output Data


```{r echo=FALSE}
t <- model_output_sim %>% 
  select(proj_type , days_from_approval_to_signature , days_from_signature_to_effectiveness,
         days_from_effectiveness_to_first_disbursement , days_from_first_to_final_disbursement)

plot_boxplot(t, by = "proj_type" , ncol = 2)

```


```{r eval=FALSE, include=FALSE}
get_each <- function(x ,data){
  data %>% 
    summarise(
    across( (starts_with("days_from") & contains(x) & !contains("_cap")) , 
            list(mean = mean , sd = sd , min = min , max = max , median = median),  
            .names = "{.fn}" ) ,
  ) %>% 
    mutate(measure = x) %>% 
    relocate(measure)
  
}

l2 <- c("approval_to_signature" , "signature_to_effectiveness" , "effectiveness_to_first" ,"first_to_final" )


map_dfr(l2, get_each , model_output_sim %>% filter( proj_type == "Not Signed")) %>% 
  gt() %>% 
    fmt_number(columns = 2:6) %>% 
  tab_header(
    title = "Projection - Not Signed Projects",
    subtitle = "Model Output Milestone Time Analysis"
  )


map_dfr(l2, get_each , ops_data %>% filter( proj_type != "Not Signed",
                                            proj_type != "Not Effective")) %>% 
  gt() %>% 
    fmt_number(columns = 2:6) %>% 
  tab_header(
    title = "Training Data Set",
    subtitle = "Milestone Time Analysis"
  )


get_each(l2[1] , ops_data %>% filter( proj_type_code > 1 ) ) %>% 
  bind_rows(get_each(l2[2] , ops_data %>% filter( proj_type_code > 2 ))) %>% 
  bind_rows(get_each(l2[3] , ops_data %>% filter( proj_type_code > 3 ))) %>% 
  bind_rows(get_each(l2[4] , ops_data %>% filter( proj_type_code > 4 )) ) %>% 
  gt() %>% 
    fmt_number(columns = 2:6) %>% 
  tab_header(
    title = "Training Data Set",
    subtitle = "Milestone Time Analysis"
  )


```



# Actual vs. Predicted Comparison

```{r datainput comp, eval=FALSE, include=FALSE}


model_input_comp <- read_csv(file = paste0(input_dir, "isdb_test_prjs_comp.csv")) %>% 
  select( -...1) %>% 
  mutate( proj_type = str_replace(project_title,  '-.*' , ''))

model_output_comp <- readRDS( file = paste0(output_dir , "model_output_comp.rda")) %>% 
  janitor::clean_names() %>% 
  mutate(
    proj_type = str_replace(project_title,  '-.*' , '')
  )

profiles_comp <- readRDS(file = paste0(output_dir , "full_disb_profile_comp.rda")) %>% 
  janitor::clean_names()

```



```{r include=FALSE}
model_input_comp_t <-
  model_input_comp %>%
  mutate(
    days_from_approval_to_signature_act = time_length(date_of_signature_act - date_of_approval , "days"),
    days_from_signature_to_effectiveness_act = time_length(date_of_effective_act - date_of_signature_act, "days"),
    days_from_effectiveness_to_first_disbursement_act  = time_length(date_of_first_disb_act - date_of_effective_act,   "days"),
    days_from_first_to_final_disbursement_act = time_length(date_of_last_disb_act - date_of_first_disb_act,   "days")
  ) %>% 
  select(project_id , contains("act") )
```



```{r join with projected, include=FALSE}

comp1 <- 
  model_output_comp %>% 
  inner_join(model_input_comp_t , by = "project_id" ) %>% 
  mutate(
    days_from_approval_to_signature_res = days_from_approval_to_signature_act - days_from_approval_to_signature,
    days_from_signature_to_effectiveness_res = days_from_signature_to_effectiveness_act - days_from_signature_to_effectiveness,
    days_from_effectiveness_to_first_disbursement_res = days_from_effectiveness_to_first_disbursement_act -
      days_from_effectiveness_to_first_disbursement,
    days_from_first_to_final_disbursement_res = days_from_first_to_final_disbursement_act - days_from_first_to_final_disbursement
    ) %>% 
  rename( date_of_effectiveness_act = date_of_effective_act,
          date_of_first_disbursement_act = date_of_first_disb_act,
          date_of_final_disbursement_act = date_of_last_disb_act )

```


```{r}
plot_act_pred <- function(milestone , data) {
  
  
  act <- paste0( "days_from_" , milestone , "_act" )
  
  pred <- paste0( "days_from_" , milestone )
  
  ptitle <- paste0( str_to_title( str_replace_all( milestone , "_" , " " ) ) )
  
  # ptype <- switch( str_remove( deparse(substitute(comp_sig)) , "comp_") , 
  #                  "sig" = "Not Signed" ,
  #                  "eff" = "Not Effective",
  #                  "fstd" = "Not Disbursing",
  #                  "lstd" = "Disbursing")
  # 
  # psubtitle <- paste0(ptype ,  " Projects") 
  
  p <- data %>% 
  ggplot( aes(x = !!sym(act) , y = !!sym(pred)) ) +
  geom_point() + 
  geom_abline(slope = 1 , intercept = 0) +
  geom_smooth(method = "lm" , formula = y ~ x + 0) +
  expand_limits(x = 0, y = 0) +
    labs(title = ptitle ,  x = "Actual" , y = "Predicted")
  
  return(p) 
}

std_res <- function(res) {
  return(
        res / sqrt( sum( res^2 ) / ( length(res) - 2 )   )
  )
}

comp_sig <-  comp1 %>% 
  filter( str_detect(project_id , "NS")) %>% 
  mutate(
    days_from_approval_to_signature_std_res = std_res(days_from_approval_to_signature_res)
    )                                                      

comp_eff <- comp1 %>% 
  filter( str_detect(project_id , "NE")) %>% 
  mutate(
    days_from_signature_to_effectiveness_std_res = std_res(days_from_signature_to_effectiveness_res)
       )                                

comp_fstd <- comp1 %>% 
  filter( str_detect(project_id , "ND"))  %>% 
  mutate(
    days_from_effectiveness_to_first_disbursement_std_res = std_res(days_from_effectiveness_to_first_disbursement_res)
       )                                

comp_lstd <- comp1 %>% 
  filter( str_detect(project_id , "CD"))  %>% 
  mutate(
      days_from_first_to_final_disbursement_std_res = std_res(days_from_first_to_final_disbursement_res)
       )                                

c1 <- c( "approval_to_signature" , "signature_to_effectiveness" , "effectiveness_to_first_disbursement" ,
         "first_to_final_disbursement")
```

```{r}
plot_res <- function(milestone , data) {
  fit <- paste0( "days_from_" , milestone  )
  
  res <- paste0( "days_from_" , milestone , "_res" )
  
  ptitle <- paste0( str_to_title( str_replace_all( milestone , "_" , " " ) ) )
  
  p <- data %>% 
  ggplot( aes(x = !!sym(fit) , y = !!sym(res)) ) +
  geom_point() + 
  geom_abline(slope = 0 , intercept = 0) +
    expand_limits(x = 0, y = 0) +
    labs(title = ptitle ,  x = "Predicted Value" , y = "Residuals")
  
  return(p) 
}

plot_std_res <- function(milestone , data) {
  fit <- paste0( "days_from_" , milestone  )
  
  res <- paste0( "days_from_" , milestone , "_std_res" )
  
  ptitle <- paste0( str_to_title( str_replace_all( milestone , "_" , " " ) ) )
  
  p <- data %>% 
  mutate( sd2 = ( abs( !!sym(res) ) > 2) ) %>% 
  ggplot( aes(x = !!sym(fit) , y = !!sym(res)) ) +
  geom_point(aes( color =  sd2 )) + 
  scale_color_manual(values=c("#458B74" , "#B22222")) +
  geom_abline(slope = 0 , intercept = 0) +
    expand_limits(x = 0, y = 0) +
    labs(title = ptitle ,  x = "Predicted Value" , y = "Std. Residuals" , caption = "RED = Outliers") +
    theme(legend.position='none',
          plot.caption = element_text(color = "#B22222", face = "italic"))
  
  return(p) 
}
```


## Not Signed Projects

Analysis of the Predicted times compared to actual. 

```{r plots, echo=FALSE}
#plot_act_pred( comp_sig , "approval_to_signature"  )
wrap_plots( map(c1, plot_act_pred , comp_sig) ) + 
  plot_annotation(
  title = 'Not Signed Projects',
  subtitle = 'Predicted vs. Actual (months)',
  caption = paste0('Based on a sample input of ' , nrow(comp_sig) , ' projects')
)
```

Analysis of Residuals

The Residual is defined as $Residual = (Y_{act} - Y_{est})$ where $Y$ is the output or predicted variable

```{r}
wrap_plots( map(c1[1], plot_res , comp_sig) ) + 
  plot_annotation(
  title = 'Not Signed Projects',
  subtitle = 'Residuals vs. Fitted Values',
  caption = paste0('Based on a sample input of ' , nrow(comp_sig) , ' projects')
)

```

Analysis of Standardized Residuals

The Standardized Residual is defined as $$S_{res} = \sqrt{\frac{\sum (Y_{act} - Y_{est})^2}{n - 2}}$$

```{r}
wrap_plots( map(c1[1], plot_std_res , comp_sig) ) + 
  plot_annotation(
  title = 'Not Signed Projects',
  subtitle = 'Standardized Residuals vs. Fitted Values',
  caption = paste0('Based on a sample input of ' , nrow(comp_sig) , ' projects')
)

```

Outlier value detection

Values where $S_{res} > 2$ are considered as Outliers

```{r}
outlier_tbl <- function(var , start_var , end_var ,  data) {
  
  varname = paste0( "days_from_" , var)
  
  #start_var = paste0( "date_of_" , str_remove(var , "_.+") )
  
  #end_var = paste0( "date_of_" , str_remove(var , "^.+_") )
  
  data %>% filter( abs( !!sym(paste0( varname , "_std_res") ) )> 2) %>%
  select(
    project_id ,
    !!sym( start_var ),
    predicted = !!sym( end_var ) ,
    actual = !!sym( paste0( end_var , "_act")  ),
    predicted_days = !!sym(varname),
    actual_days = !!sym(paste0( varname , "_act")),
    residual = !!sym(paste0( varname , "_res"))
  ) %>%
  gt() 
}


c2 <- c( "date_of_approval" , "date_of_signature" ,  "date_of_effectiveness" , "date_of_first_disbursement" , "date_of_final_disbursement")

outlier_tbl( c1[1] , c2[1] , c2[2] , comp_sig) %>% 
    tab_header(
    title = "Model Outliers - Not Signed Projects",
    subtitle = "Date of Signature"
  )

```



## Not Effective Projects

Analysis of the Predicted effectiveness times compared to actual. 

```{r, echo=FALSE}
wrap_plots( map(c1[2:4], plot_act_pred , comp_eff) , ncol = 2 ) + 
  plot_annotation(
  title = 'Not Effective Projects',
  subtitle = 'Predicted vs. Actual (days)',
  caption = paste0('Based on a sample input of ' , nrow(comp_sig) , ' projects')
)
```

Analysis of Residuals


```{r}
wrap_plots( map(c1[2], plot_res , comp_eff) ) + 
  plot_annotation(
  title = 'Not Effective Projects',
  subtitle = 'Residuals vs. Fitted Values',
  caption = paste0('Based on a sample input of ' , nrow(comp_sig) , ' projects')
)

```

Analysis of Standardized Residuals


```{r}
wrap_plots( map(c1[2], plot_std_res , comp_eff) ) + 
  plot_annotation(
  title = 'Not Effective Projects',
  subtitle = 'Standardized Residuals vs. Fitted Values',
  caption = paste0('Based on a sample input of ' , nrow(comp_sig) , ' projects')
)

```


Outliers

```{r}
outlier_tbl( c1[2] ,  c2[2] , c2[3] , comp_eff) %>% 
    tab_header(
    title = "Model Outliers - Not Effective Projects",
    subtitle = "Date of Effectiveness"
  )
```


## Not Disbursing Projects

Analysis of the Predicted 1st Disbursement times compared to actual. 

```{r, echo=FALSE}
wrap_plots( map(c1[3:4], plot_act_pred , comp_fstd) , ncol = 2 ) + 
  plot_annotation(
  title = 'Not Disbursing Projects',
  subtitle = 'Predicted vs. Actual (days)',
  caption = paste0('Based on a sample input of ' , nrow(comp_sig) , ' projects')
)
```

Analysis of Residuals


```{r}
wrap_plots( map(c1[3], plot_res , comp_fstd) ) + 
  plot_annotation(
  title = 'Not Disbursing Projects',
  subtitle = 'Residuals vs. Fitted Values',
  caption = paste0('Based on a sample input of ' , nrow(comp_sig) , ' projects')
)

```

Analysis of Standardized Residuals


```{r}
wrap_plots( map(c1[3], plot_std_res , comp_fstd) ) + 
  plot_annotation(
  title = 'Not Disbursing Projects',
  subtitle = 'Standardized Residuals vs. Fitted Values',
  caption = paste0('Based on a sample input of ' , nrow(comp_sig) , ' projects')
)

```


Outliers

```{r}
outlier_tbl( c1[3] ,  c2[3] , c2[4] , comp_fstd) %>% 
    tab_header(
    title = "Model Outliers - Not Disbursing Projects",
    subtitle = "Date of 1st Disb."
  )
```





## Disbursing Projects

Analysis of the Predicted 1st to last Disbursement times compared to actual. 

```{r, echo=FALSE}
wrap_plots( map(c1[4], plot_act_pred , comp_fstd)  ) + 
  plot_annotation(
  title = 'Disbursing Projects',
  subtitle = 'Predicted vs. Actual (days)',
  caption = paste0('Based on a sample input of ' , nrow(comp_sig) , ' projects')
)
```

Analysis of Residuals


```{r}
wrap_plots( map(c1[4], plot_res , comp_lstd) ) + 
  plot_annotation(
  title = 'Disbursing Projects',
  subtitle = 'Residuals vs. Fitted Values',
  caption = paste0('Based on a sample input of ' , nrow(comp_sig) , ' projects')
)

```

Analysis of Standardized Residuals


```{r}
wrap_plots( map(c1[4], plot_std_res , comp_lstd) ) + 
  plot_annotation(
  title = 'Disbursing Projects',
  subtitle = 'Standardized Residuals vs. Fitted Values',
  caption = paste0('Based on a sample input of ' , nrow(comp_sig) , ' projects')
)

```


Outliers

```{r}
outlier_tbl( c1[4] ,  c2[4] , c2[5] , comp_lstd) %>% 
    tab_header(
    title = "Model Outliers - Not Disbursing Projects",
    subtitle = "Date of Final Disb."
  )
```






```{r eval=FALSE, include=FALSE}
comp_sig %>% 
  ggplot( aes(x = days_from_approval_to_signature , y = days_from_approval_to_signature_res)) +
  geom_point() + 
  geom_abline(slope = 0 , intercept = 0) +
  expand_limits(x = 0, y = 0)

comp_sig %>% 
  ggplot( aes(x = days_from_approval_to_signature , y = scale(days_from_approval_to_signature_res)) ) +
  geom_point() + 
  geom_abline(slope = 0 , intercept = 0) +
  expand_limits(x = 0, y = 0)



comp_sig %>% 
  ggplot( aes(x = days_from_approval_to_signature , y = days_from_approval_to_signature_std_res) ) +
  geom_point() + 
  geom_abline(slope = 0 , intercept = 0) +
  expand_limits(x = 0, y = 0)

comp_sig %>% 
  ggplot( aes(sample = days_from_approval_to_signature)) +
  stat_qq() +
  stat_qq_line()


comp_sig %>% 
  ggplot( aes(days_from_approval_to_signature_act)) +
  geom_histogram(aes(y=..density.. ) , bins = 30 , alpha = .5)+
  geom_density()


plot_hist(comp_sig , comp_sig$days_from_approval_to_signature_res)

comp_sig %>% 
  ggplot( aes(sample = days_from_approval_to_signature_res)) +
  stat_qq() +
  stat_qq_line()

```

```{r measures, eval=FALSE, include=FALSE}

comp_sig %>% 
  yardstick::metrics(days_from_approval_to_signature_act, days_from_approval_to_signature )

comp_eff %>% 
  yardstick::metrics(days_from_signature_to_effectiveness_act, days_from_signature_to_effectiveness )

comp_fstd %>% 
  yardstick::metrics(days_from_effectiveness_to_first_disbursement_act,  days_from_effectiveness_to_first_disbursement )

comp_lstd %>% 
  yardstick::metrics(days_from_first_to_final_disbursement_act,  days_from_first_to_final_disbursement )

```
