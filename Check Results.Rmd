---
title: "Check Results"
output: html_notebook
editor_options: 
  chunk_output_type: console
---

```{r}
library(tidyverse)
library(lubridate)
library(readxl)


```

```{r}

dir <- getwd()   #Updates the path to the directory where the R Code is present
input_dir <- paste0(dir, "/Inputs/") 

output_dir <- paste0(dir , "/Outputs/")

ops_data_check <- read_csv(file = paste0(input_dir, "isdb_test_prjs.csv"))

# profiles <- read_csv(file = paste0(output_dir , "IsDB Projects & LoF Disbursement Modelling Profiles idb_test 11-Jan-2022 15.56.12"))



profiles <- readRDS(file = paste0(output_dir , "full_disb_profile.rda")) %>% 
  janitor::clean_names()


model_output <- readRDS( file = paste0(output_dir , "model_output.rda")) %>% 
  janitor::clean_names()

write_csv(profiles , paste0(output_dir , "full_disb_profile.csv") )

```


```{r}

ops_data_check %>%  summarise( total_apr_amt = sum(approval_amount_usd)/1e6)


profiles %>%  summarise( total_disb = sum( amount_disbursed_between_tenors ) /1e6 )




```



```{r}

eval_date <- dmy("01-01-2022")

bins <- seq(0, 14400 , 180)

theme_set(theme_minimal())

profiles <- profiles %>% 
    mutate( days_from_eval = time_length(date_of_disbursement - eval_date , "day"), 
    days_bin  = cut(days_from_eval , bins , include.lowest = TRUE)) 

profiles %>% 
  ggplot( aes(x = days_bin , amount_disbursed_between_tenors)) +
  geom_col(fill = "skyblue4")

```


```{r}

library(patchwork)


plot_hist <- function(var){
  
  mean_val = mean(var)
  
  var_name = str_remove( deparse(substitute(var)) , "model_output\\$days_from_" )
  
  

  
  model_output %>% 
  ggplot(aes(var)) +
  geom_histogram(aes(y=..density..), fill="lightblue")+
  geom_density(alpha=.2, fill="#FF6666") +
  geom_vline(aes(xintercept= mean_val),
            color="black", linetype="dashed", size=.5 , alpha = .5) +
  annotate("text" , x = mean_val , y  = 0 , label = paste0(mean_val)) +
  labs(title = var_name)
  
}



p1 <- plot_hist(model_output$days_from_approval_to_signature)
  
  
p2 <- plot_hist(model_output$days_from_signature_to_effectiveness)


p3 <- plot_hist(model_output$days_from_effectiveness_to_first_disbursement)
  
  
p4 <- plot_hist(model_output$days_from_first_to_final_disbursement)
  
 

(p1 | p2) / (p3 | p4)

```


