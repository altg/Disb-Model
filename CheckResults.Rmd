---
title: "Check Results"
output:
  pdf_document: default
  html_notebook: default
  html_document:
    df_print: paged
editor_options:
  chunk_output_type: console
---


```{r include=FALSE}
library(tidyverse)
library(lubridate)
library(readxl)
library(DataExplorer)

library(gt)

```


# Testing Method

The Disbursement Projection Model developed by Moody's Analytics is tested by using a generated test sample which is representative of the actual data. The objective here is to see how the model performs in the presence of new / unseen data.


```{r include=FALSE}

dir <- getwd()   #Updates the path to the directory where the R Code is present
input_dir <- paste0(dir, "/Inputs/") 

output_dir <- paste0(dir , "/Outputs/")

model_input <- read_csv(file = paste0(input_dir, "isdb_test_prjs.csv")) %>% 
  select( -...1) %>% 
  mutate( proj_type = str_replace(project_title,  '-.*' , ''))

# profiles <- read_csv(file = paste0(output_dir , "IsDB Projects & LoF Disbursement Modelling Profiles idb_test 11-Jan-2022 15.56.12"))



profiles <- readRDS(file = paste0(output_dir , "full_disb_profile.rda")) %>% 
  janitor::clean_names()


model_output <- readRDS( file = paste0(output_dir , "model_output.rda")) %>% 
  janitor::clean_names() %>% 
  mutate(
    proj_type = str_replace(project_title,  '-.*' , '')
  )

write_csv(profiles , paste0(output_dir , "full_disb_profile.csv") )

```

## Sample data used

The Test data set used was generated from the actual dataset used for training using a random sampling technique.

Structure of the Test Data Set:

```{r}
model_input %>% introduce() %>%  pivot_longer(1:9, names_to = "Item" , values_to = "value") %>% gt()
```



```{r}
model_input %>%  plot_histogram()

model_input %>%  plot_bar()

```


The Test data set is composed as follows:

```{r echo=FALSE}
model_input %>% 
  group_by(proj_type) %>% 
  summarise(no_of_projects = n()) %>% 
  arrange(desc(proj_type)) %>% 
  gt() %>% 
  tab_header(
    title = md("**Test Dataset**"),
    subtitle = md("Breakdown by Project Milestone Type")
  ) %>% 
  summary_rows(
    columns = no_of_projects,
    fns = list( ~sum(.) ),
    formatter = fmt_number,
    use_seps = FALSE
  )
```


## Missing Values


```{r}
model_input %>%  plot_missing()
```



The data set under each category is balanced using stratified sampling from the original data set.


```{r}

theme_set(theme_minimal())

plot_dcvar <- function(var) {
  
  model_input %>% 
  group_by( proj_type ) %>% 
  count( !!sym(var) , sort = T) %>% 
  mutate( dc_var = tidytext::reorder_within( !!sym(var) ,  n , proj_type)) %>% 
  ggplot(aes( dc_var , n)) +
  geom_col(aes(fill=proj_type), show.legend = FALSE) +
  coord_flip() +
  tidytext::scale_x_reordered() +
  facet_wrap(~proj_type, scales = "free_y") 
  
}
```



```{r echo=FALSE}

#plot_dcvar("sector")

l <- c( "sector" , "sub_mode_of_finance" , "profile" , "income_classification")

map(l , plot_dcvar)

# model_input %>% 
#   group_by( proj_type ) %>% 
#   count( sector , sort = T) %>% 
#   mutate( sector = tidytext::reorder_within(sector,  n , proj_type)) %>% 
#   ggplot(aes( sector , n)) +
#   geom_col(aes(fill=proj_type), show.legend = FALSE) +
#   coord_flip() +
#   tidytext::scale_x_reordered() +
#   facet_wrap(~proj_type, scales = "free_y") 

```

# Model Output Checks

A number of tests are run on the output produced by the model.

## Reconciliation of disbursed amounts 


```{r echo=FALSE}


model_output <- model_output %>% 
  inner_join( model_input %>%  select(where( is.character ) , -proj_type , -project_title, -project_title_org  ) , by = c("project_id"))

# ops_data_check %>%  
#   summarise( total_apr_amt = sum(approval_amount_usd)/1e6 , 
#              amount_already_disb = sum(amount_disbursed_at_evaluation_date_usd)/1e6) %>% 
#   mutate( total_disb_est = (total_apr_amt - amount_already_disb) )

apr_amt <- model_input %>%  
   summarise( total_apr_amt = sum(approval_amount_usd)/1e6 ) 

disb_amt <- profiles %>%  summarise( total_disb = sum( amount_disbursed_between_tenors ) /1e6 )

tibble( 
  apr_amt,
  disb_amt 
  ) %>% 
  mutate(
    match = (  apr_amt == disb_amt )
  ) %>% 
  gt() %>% 
  fmt_number(columns = 1:2) %>% 
  tab_footnote(
    footnote = "Total value of approved amounts from Test data set (input)",
    locations = cells_column_labels(
      columns = 1
    )
  ) %>% 
  tab_footnote(
    footnote = "Total value of disbursed amounts from disbursement profiles generated from the model",
    locations = cells_column_labels(
      columns = 2
    )
  ) %>% 
  tab_header(
    title = "Model Input / Output Reconciliation"
  )
  

# check1 <- ops_data_check %>% 
#   left_join(
#     profiles %>% 
#       group_by(project_id) %>% 
#       summarise( amt_disb = sum( amount_disbursed_between_tenors ) )
#   )


```


```{r eval=FALSE, include=FALSE}

#eval_date <- dmy("01-01-2022")

bins <- seq(0, 14400 , 180)

theme_set(theme_minimal())

profiles <- profiles %>% 
    mutate( 
      #days_from_eval = time_length(date_of_disbursement - evaluation_day , "day"), 
    days_bin  = cut(days_from_first_disbursement , bins , include.lowest = TRUE)) 

profiles %>% 
  ggplot( aes(x = days_bin , amount_disbursed_between_tenors)) +
  geom_col(fill = "skyblue4")

```

# Plot data

```{r include=FALSE}
library(patchwork)


plot_hist <- function(data_src , var){
  
  mean_val = mean(var)
  
  #medean_val = median(var)
  
  var_name = str_remove( deparse(substitute(var)) , ".*\\$days_from_" )
  
  #geom_histogram(aes(y=..density.. , fill = ), fill="lightblue")+

  
  data_src %>% 
  ggplot(aes(var)) +
  #geom_histogram(aes(y=..density.. , fill = catch_up_shift ) )+
  geom_histogram(aes(y=..density.. ) , bins = 30 , alpha = .5)+
  #geom_density(alpha=.2, fill="#FF6666") +
  geom_density(alpha=.2) + 
  geom_vline(aes(xintercept= mean_val),
            color="black", linetype="dashed", size=.5 , alpha = .5) +
  # geom_vline(aes(xintercept= medean_val),
  #           color="blue", linetype="dashed", size=.5 , alpha = .5) +
  annotate("text" , x = mean_val , y  = 0 , label = paste0(sprintf("Avg. %.2f",mean_val)) , color = "red") +
  labs(title = var_name)
  
}
```

```{r plot dist, include=FALSE}

plot_dist <- function(var1 , time_days, data) {
  
  time_days2 <- paste0( "days_from_" , time_days)
  
  p <- data %>%
  mutate( dc_var = fct_reorder(!!sym(var1) , !!sym(time_days2)) ) %>% 
  ggplot(aes( !!sym(time_days2) , dc_var )) +
  geom_boxplot(aes(fill = !!sym(var1) ) , show.legend = FALSE,
               alpha = 0.5 , outlier.colour = "red", outlier.shape = 1, outlier.alpha = 0.5) +
  #geom_jitter(width = 0.05) +
  labs( title = time_days , subtitle = paste0( "by " , var1)) +
  xlab(paste0(time_days, " (days)") )+
  ylab(var1)
  
  
  return(p)
}


#plot_dist("sector","approval_to_signature" , model_output)


l3 <- c("sector" , "sub_mode_of_finance" , "income_classification" , "profile.y" )

l4 <- c("approval_to_signature" ,   "signature_to_effectiveness" , "effectiveness_to_first_disbursement"   ,  "first_to_final_disbursement")


plot_dist2 <- function(var , data) {
  return(map( l3 ,  plot_dist  , var, data ))
}


t <- map(l4 , plot_dist2 , model_output %>% filter(proj_type == "Not Signed") )


#wrap_plots(t[[1]])

map( 1:4 , ~wrap_plots(t[[.x]]) )

# plot_dist("sector" , "days_from_approval_to_signature" , 
#           model_output %>% filter(proj_type == "Not Signed") )

```


# Not Signed Projects

```{r echo=FALSE}


data_in <- model_output %>% 
  filter(proj_type == "Not Signed" )

p1 <- plot_hist(data_in , data_in$days_from_approval_to_signature)
  
  
p2 <- plot_hist(data_in , data_in$days_from_signature_to_effectiveness)


p3 <- plot_hist(data_in , data_in$days_from_effectiveness_to_first_disbursement)
  
  
p4 <- plot_hist(data_in , data_in$days_from_first_to_final_disbursement)
  
 

(p1 | p2) / (p3 | p4) + plot_annotation(
  title = 'Model Output - Projects Not Signed',
  subtitle = 'Distribution of projected time-taken by milestones(months)',
  caption = paste0('Based on a sample input of ' , nrow(data_in) , ' Approved but not Signed projects')
)

```





## Summary Table

```{r include=FALSE}
get_each <- function(x ,data){
  data %>% 
    summarise(
    across( (starts_with("days_from") & contains(x) & !contains("_cap")) , 
            list(mean = mean , sd = sd , min = min , max = max , median = median),  
            .names = "{.fn}" ) ,
  ) %>% 
    mutate(measure = x) %>% 
    relocate(measure)
  
}



# get_summary <- function( data ){
#   
#   
#   get_each(data , "approval_to_signature") %>% 
#   bind_rows(
#     get_each(data , "signature_to_effectiveness")
#   ) %>% 
#   bind_rows(
#     get_each(data , "effectiveness_to_first")
#   ) %>% 
#   bind_rows(
#     get_each(data , "first_to_final")
#   ) %>% 
#     gt() %>% 
#     fmt_number(columns = 2:6)
#   
# }
# 
# 
# get_summary( model_output %>% filter( proj_type == "Not Signed") )


```




```{r not signed, echo=FALSE}
l2 <- c("approval_to_signature" , "signature_to_effectiveness" , "effectiveness_to_first" ,"first_to_final" )


map_dfr(l2, get_each , model_output %>% filter( proj_type == "Not Signed")) %>% 
  gt() %>% 
    fmt_number(columns = 2:6) %>% 
  tab_header(
    title = "Not Signed Projects",
    subtitle = "Model Output Milestone Time Analysis"
  )

```


# Not Effective Projects

```{r echo=FALSE}


data_in <- model_output %>% 
  filter(str_detect( project_title, "Not Effective" ) )

#p1 <- plot_hist(data_in , data_in$days_from_approval_to_signature)
  
  
p2 <- plot_hist(data_in , data_in$days_from_signature_to_effectiveness)


p3 <- plot_hist(data_in , data_in$days_from_effectiveness_to_first_disbursement)
  
  
p4 <- plot_hist(data_in , data_in$days_from_first_to_final_disbursement)
  
 

(p2 | p3) / (p4) + plot_annotation(
  title = 'Model Output - Projects Not Effective',
  subtitle = 'Distribution of projected time-taken by milestones(months)',
  caption = paste0('Based on a sample input of ' , nrow(data_in) , ' Signed but not Effective projects')
)

```



# Not Disbursing Projects

```{r echo=FALSE}


data_in <- model_output %>% 
  filter(str_detect( project_title, "Not Disbursing" ) )

#p1 <- plot_hist(data_in , data_in$days_from_approval_to_signature)
  
  

p3 <- plot_hist(data_in , data_in$days_from_effectiveness_to_first_disbursement)
  
  
p4 <- plot_hist(data_in , data_in$days_from_first_to_final_disbursement)
  
 

(p3 | p4)  + plot_annotation(
  title = 'Model Output - Projects Not Disbursing',
  subtitle = 'Distribution of projected time-taken by milestones(months)',
  caption = paste0('Based on a sample input of ' , nrow(data_in) , ' Effective but not Disbursing projects')
)

```

# Disbursing Projects

```{r echo=FALSE}


data_in <- model_output %>% 
  filter(str_detect( project_title, "Not Disbursing" ) )

#p1 <- plot_hist(data_in , data_in$days_from_approval_to_signature)
  
  


  
  
p4 <- plot_hist(data_in , data_in$days_from_first_to_final_disbursement)
  
 

(p4)  + plot_annotation(
  title = 'Model Output - Projects Not Disbursing',
  subtitle = 'Distribution of projected time-taken by milestones(months)',
  caption = paste0('Based on a sample input of ' , nrow(data_in) , ' Disbursing projects')
)

```



```{r eval=FALSE, include=FALSE}

t <- 
  model_input %>% 
    mutate(
      days_from_approval_to_signature = time_length( date_of_signature - date_of_approval , unit = "day" ),
      days_from_signature_to_effectiveness = time_length( date_of_effectiveness - date_of_signature  , unit = "day" ),
      days_from_effectiveness_to_first_disbursement = time_length( date_of_first_disbursement - date_of_effectiveness , unit = "day" ),
      
    )


get_summary(model_input)
```


```{r eval=FALSE, include=FALSE}



get_summary2 <- function(data , x){
  data %>% 
    select( (starts_with("days_from") & contains(x) & !contains("_cap")) )
}


get_summary(model_output , "approval_to_signature") 

model_output %>% 
  select( starts_with("days_from") & !contains("_cap") ) %>%  

model_output %>% 
  filter( proj_type == "Not Signed" ) %>% 
  summarise(
    across( (starts_with("days_from") & !contains("_cap")) , 
            list(mean = mean , sd = sd ),  
            .names = "{.fn}" ) ,
  ) %>%  gt()

show_table <- function ( data  )
{
data %>% 
  summarise(avg = mean(days_from_approval_to_signature) , 
            max = max(days_from_approval_to_signature),
            min = min(days_from_approval_to_signature),
            median = median(days_from_approval_to_signature)) %>% 
  gt() %>% 
  tab_header(
    title = "Time from Approval to Signature"
  )
}  

show_table(model_output)

```
